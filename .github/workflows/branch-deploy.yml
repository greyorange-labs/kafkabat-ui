name: "Feature Testing: Build and Push Docker Image"

on:
  workflow_dispatch:

  pull_request:
    types: ['labeled']

permissions:
  contents: read
  statuses: write

jobs:
  build-and-push:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.label.name == 'status/feature_testing' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2 # infered from @v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          token: ${{ github.token }}

      - name: Get branch tag and repo name
        id: extract_info
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            tag='pr${{ github.event.pull_request.number }}'
          else
            tag='manual-${GITHUB_SHA::7}'
          fi
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          repo_name=$(basename ${{ github.repository }})
          echo "repo_name=${repo_name}" >> $GITHUB_OUTPUT

      - name: Set up JDK
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # infered from @v4
        with:
          java-version-file: '.java-version'
          distribution: 'zulu'
          cache: 'gradle'

      - name: Build JAR
        id: build
        run: |
          version=${GITHUB_SHA::7}
          echo "version=$version" >> $GITHUB_OUTPUT
          ./gradlew clean build \
            -x test \
            -Pinclude-frontend=true \
            -Pversion=$version

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # infered from @v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # infered from @v3

      - name: Cache Docker layers
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # infered from @v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # infered from @v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # infered from @v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: api
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.extract_info.outputs.repo_name }}:${{ steps.extract_info.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.extract_info.outputs.repo_name }}:${{ steps.build.outputs.version }}
          build-args: |
            JAR_FILE=build/libs/api-${{ steps.build.outputs.version }}.jar
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache

      - name: Update status check
        if: github.event_name == 'pull_request'
        uses: Sibz/github-status-action@650dd1a882a76dbbbc4576fb5974b8d22f29847f # infered from @v1.1.6
        with:
          authToken: ${{ secrets.GITHUB_TOKEN }}
          context: "Docker Image Built"
          state: "success"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.extract_info.outputs.repo_name }}/tags"
